<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog CRUD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
    <div class="mb-3">
        <label for="txtTitle" class="form-label">Title</label>
        <input type="text" id="txtTitle" class="form-control">
    </div>
    <div class="mb-3">
        <label for="txtAuthor" class="form-label">Author</label>
        <input type="text" id="txtAuthor" class="form-control">
    </div>
    <div class="mb-3">
        <label for="txtContent" class="form-label">Content</label>
        <textarea class="form-control" id="txtContent" rows="3"></textarea>
    </div>

    <button type="button" id="btnCancel" class="btn btn-secondary">Cancel</button>
    <button type="button" id="btnSave" class="btn btn-success">Save</button>

    <table class="table table-responsive">
        <thead>
            <tr>
                <th></th>
                <th>No.</th>
                <th>Title</th>
                <th>Author</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody id="tblBlogs">
            
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- <script src="jquery.min.js"></script> -->

    <script>
        $('#btnCancel').click(() => {
            clearControls()
        });

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }

        function clearControls() {
            $('#txtTitle').val(''),
            $('#txtAuthor').val(''),
            $('#txtContent').val(''),

            $('#txtTitle').focus()
        }

        // Create
        $('#btnSave').click(() => {
            if (editId == null) {
                blogCreate();
            } 
            else {
                blogUpdate();
            }
        });

        function blogCreate() {
            const title = $('#txtTitle').val();
            const author = $('#txtAuthor').val();
            const content = $('#txtContent').val();

            let lts = getData();

            const blog = {
                id: uuidv4(),
                title: title,
                author: author,
                content: content
            };

            lts.push(blog);

            const jsonStr = JSON.stringify(lts)
            localStorage.setItem('blogs', jsonStr);

            clearControls();

            alert('Saved successfully');

            loadData();
        }

        function blogUpdate() {
            const title = $('#txtTitle').val();
            const author = $('#txtAuthor').val();
            const content = $('#txtContent').val();

            let lts = getData();

            let index = lts.findIndex(x => x.id == editId);
            lts[index].title = title;
            lts[index].author = author;
            lts[index].content = content;

            const jsonStr = JSON.stringify(lts);
            localStorage.setItem('blogs', jsonStr);

            clearControls();
            editId = null;

            alert('Updated successfully');

            loadData();
        }

        $(document).ready(function() {
            loadData();
        });

        function getData() {
            let lts = localStorage.getItem('blogs');
            if (lts == null) {
                lts = [];
            }
            else {
                lts = JSON.parse(lts);
            }

            return lts;
        }

        // Read
        function loadData() {
            let lts = getData();

            // let trs = '';
            $('#tblBlogs').html('');
            for (let i = 0; i < lts.length; i++) {
                const blog = lts[i];
                const tr = `
                    <tr>
                        <td>
                            <button type="button" class="btn btn-warning btn-edit" data-blog-id=${blog.id}>Edit</button>    
                            <button type="button" class="btn btn-danger btn-delete" data-blog-id=${blog.id}>Delete</button>
                        </td>
                        <td>${i + 1}</td>
                        <td>${blog.title}</td>    
                        <td>${blog.author}</td>    
                        <td>${blog.content}</td>    
                    </tr>`;
                $('#tblBlogs').append(tr);
                // trs += tr;
            }
            // $('#tblBlogs').html(trs);
            bindEditButton();
            bindDeleteButton();
        }

        let editId = null;

        // Edit
        function bindEditButton() {
            $('.btn-edit').click(function () {
                let id = $(this).data('blog-id');

                let lts = getData();
                let filterList = lts.filter(x => x.id == id);
                let item = filterList[0];

                $('#txtTitle').val(item.title);
                $('#txtAuthor').val(item.author);
                $('#txtContent').val(item.content);

                editId = item.id;
            });
        }

        function bindDeleteButton() {
            $('.btn-delete').click(function() {
                let result = confirm('Are you sure to delete?');
                if (!result) return;
                
                let id = $(this).data('blog-id');

                let lts = getData();

                lts = lts.filter(x => x.id != id);

                const jsonStr = JSON.stringify(lts);
                localStorage.setItem('blogs', jsonStr);

                clearControls();

                alert('Deleted successfully');

                loadData();
            })
        }

        /* $(document).ready(() => {
            let lts = localStorage.getItem('blogs');
            console.log(lts);
            if (lts == null) {
                lts = [];
            }
            else {
                lts = JSON.parse(lts)
            }

            const blog = {
                title: 'title',
                author: 'author',
                content: 'content'
            };

            lts.push(blog);
            
            const jsonStr = JSON.stringify(lts);
            localStorage.setItem('blogs', jsonStr);
        }); */

        function bindBulkUpdate() 
    </script>
</body>
</html>